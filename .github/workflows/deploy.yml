name: Deploy Bisca

on:
  push:
    branches:
      - test
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set environment variables
        id: vars
        run: |
          if [ "${{ github.ref_name }}" = "master" ]; then
            echo "ENV=prod" >> $GITHUB_OUTPUT
            echo "ENV_UPPER=PROD" >> $GITHUB_OUTPUT
            echo "WEB_PORT=3007" >> $GITHUB_OUTPUT
            echo "WS_PORT=3008" >> $GITHUB_OUTPUT
            echo "BASE_PATH=/prod/bisca" >> $GITHUB_OUTPUT
          else
            echo "ENV=test" >> $GITHUB_OUTPUT
            echo "ENV_UPPER=TEST" >> $GITHUB_OUTPUT
            echo "WEB_PORT=3005" >> $GITHUB_OUTPUT
            echo "WS_PORT=3006" >> $GITHUB_OUTPUT
            echo "BASE_PATH=/test/bisca" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: npm ci

      - name: Create .env file
        run: |
          echo "NEXT_PUBLIC_BASE_PATH=${{ steps.vars.outputs.BASE_PATH }}" > .env
          echo "NEXT_PUBLIC_SOCKET_URL=http://77.42.70.58${{ steps.vars.outputs.BASE_PATH }}" >> .env

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.vars.outputs.BASE_PATH }}
          NEXT_PUBLIC_SOCKET_URL: http://77.42.70.58${{ steps.vars.outputs.BASE_PATH }}

      - name: Prepare deployment package
        run: |
          mkdir -p deploy-package

          # Copy standalone build
          shopt -s dotglob
          cp -r .next/standalone/* deploy-package/
          shopt -u dotglob

          # Copy static assets
          mkdir -p deploy-package/.next/static
          cp -r .next/static/* deploy-package/.next/static/

          # Copy public folder if exists
          if [ -d "public" ]; then
            cp -r public deploy-package/
          fi

          # Copy server folder for WebSocket server
          cp -r server deploy-package/

          # Copy package.json for server script
          cp package.json deploy-package/

          # Copy env file
          cp .env deploy-package/.env

          # Debug
          echo "=== Deployment package structure ==="
          ls -la deploy-package/

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy to server
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: /var/www/${{ steps.vars.outputs.ENV }}/bisca
          PM2_WEB: bisca-${{ steps.vars.outputs.ENV }}-web
          PM2_SERVER: bisca-${{ steps.vars.outputs.ENV }}-server
          WEB_PORT: ${{ steps.vars.outputs.WEB_PORT }}
          WS_PORT: ${{ steps.vars.outputs.WS_PORT }}
          BASE_PATH: ${{ steps.vars.outputs.BASE_PATH }}
        run: |
          export SSHPASS

          # Create deployment directory and stop existing processes
          sshpass -e ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            mkdir -p $DEPLOY_PATH
            pm2 stop $PM2_WEB 2>/dev/null || true
            pm2 delete $PM2_WEB 2>/dev/null || true
            pm2 stop $PM2_SERVER 2>/dev/null || true
            pm2 delete $PM2_SERVER 2>/dev/null || true
            rm -rf $DEPLOY_PATH/*
          "

          # Copy files to server
          sshpass -e rsync -avz --delete \
            -e 'ssh -o StrictHostKeyChecking=no' \
            deploy-package/ "$SSH_USER@$SSH_HOST:$DEPLOY_PATH/"

          # Install tsx and start applications with PM2
          sshpass -e ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" bash << REMOTESH
          cd $DEPLOY_PATH

          # Install tsx for running TypeScript server
          npm install tsx --save-dev

          # Source env
          set -a
          source .env
          set +a

          # Start WebSocket server first
          PORT=$WS_PORT CLIENT_URL=http://77.42.70.58$BASE_PATH pm2 start ./node_modules/.bin/tsx \
            --name $PM2_SERVER \
            -- server/index.ts

          # Start Next.js frontend
          PORT=$WEB_PORT NODE_ENV=production pm2 start server.js --name $PM2_WEB

          # Wait and check status
          sleep 3
          pm2 list
          pm2 logs $PM2_WEB --lines 20 --nostream || true
          pm2 logs $PM2_SERVER --lines 20 --nostream || true

          pm2 save
          REMOTESH

      - name: Configure Nginx
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          APP_ENV: ${{ steps.vars.outputs.ENV }}
          WEB_PORT: ${{ steps.vars.outputs.WEB_PORT }}
          WS_PORT: ${{ steps.vars.outputs.WS_PORT }}
        run: |
          export SSHPASS
          sshpass -e ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            if ! grep -q 'location /$APP_ENV/bisca' /etc/nginx/sites-enabled/default; then
              sed -i '/# Default location/i \\
                # bisca $APP_ENV WebSocket (port $WS_PORT)\\
                location /$APP_ENV/bisca/socket.io/ {\\
                    proxy_pass http://127.0.0.1:$WS_PORT/socket.io/;\\
                    proxy_http_version 1.1;\\
                    proxy_set_header Upgrade \\\$http_upgrade;\\
                    proxy_set_header Connection \"upgrade\";\\
                    proxy_set_header Host \\\$host;\\
                    proxy_set_header X-Real-IP \\\$remote_addr;\\
                    proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;\\
                    proxy_set_header X-Forwarded-Proto \\\$scheme;\\
                    proxy_cache_bypass \\\$http_upgrade;\\
                    proxy_read_timeout 86400;\\
                }\\
                \\
                # bisca $APP_ENV frontend (port $WEB_PORT)\\
                location /$APP_ENV/bisca {\\
                    proxy_pass http://127.0.0.1:$WEB_PORT;\\
                    proxy_http_version 1.1;\\
                    proxy_set_header Upgrade \\\$http_upgrade;\\
                    proxy_set_header Connection upgrade;\\
                    proxy_set_header Host \\\$host;\\
                    proxy_set_header X-Real-IP \\\$remote_addr;\\
                    proxy_set_header X-Forwarded-For \\\$proxy_add_x_forwarded_for;\\
                    proxy_set_header X-Forwarded-Proto \\\$scheme;\\
                    proxy_cache_bypass \\\$http_upgrade;\\
                }\\
              ' /etc/nginx/sites-enabled/default
              nginx -t && systemctl reload nginx
            fi
          "

      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ job.status }}
          ENV_NAME: ${{ steps.vars.outputs.ENV }}
          ENV_UPPER: ${{ steps.vars.outputs.ENV_UPPER }}
          BASE_PATH: ${{ steps.vars.outputs.BASE_PATH }}
          COMMIT_SHA: ${{ github.sha }}
          PREV_SHA: ${{ github.event.before }}
          AUTHOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
        run: |
          # Get all commits since last deployment
          if [ "$PREV_SHA" = "0000000000000000000000000000000000000000" ]; then
            COMMIT_COUNT=1
            CHANGES=$(git log -1 --pretty="$'\u2022' %h %s")
          else
            COMMIT_COUNT=$(git rev-list --count ${PREV_SHA}..HEAD 2>/dev/null || echo "1")
            CHANGES=$(git log ${PREV_SHA}..HEAD --pretty="$'\u2022' %h %s" --reverse | head -15)
          fi

          CHANGES=$(echo "$CHANGES" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

          if [ "$COMMIT_COUNT" -gt 15 ]; then
            CHANGES="${CHANGES}
          ... and $((COMMIT_COUNT - 15)) more commits"
          fi

          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            STATUS_TEXT="Deploy Successful"
          else
            EMOJI="❌"
            STATUS_TEXT="Deploy Failed"
          fi

          TEXT="${EMOJI} <b>${ENV_UPPER} ${STATUS_TEXT}</b>

          <b>Project:</b> bisca
          <b>Branch:</b> ${ENV_NAME}
          <b>By:</b> ${AUTHOR}
          <b>Commits:</b> ${COMMIT_COUNT}

          <b>Changes:</b>
          ${CHANGES}

          <a href=\"https://github.com/${REPO}/compare/${PREV_SHA}...${COMMIT_SHA}\">View All Changes</a>
          <b>URL:</b> http://77.42.70.58${BASE_PATH}/"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"
